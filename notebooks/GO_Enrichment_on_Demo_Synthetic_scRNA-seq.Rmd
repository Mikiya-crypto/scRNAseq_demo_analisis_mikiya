---
title: "GO Enrichment on Demo Synthetic scRNA-seq"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE, fig.path = "figs/go_")
suppressPackageStartupMessages({
  library(Seurat); library(SeuratObject); library(Matrix); library(dplyr); library(ggplot2); library(patchwork)
})
set.seed(123)

# Paths
data_dir_up    <- normalizePath(file.path("..","data"), mustWork = FALSE)
data_dir_here  <- normalizePath(file.path("data"), mustWork = FALSE)
results_dir    <- normalizePath(file.path("..","results"), mustWork = FALSE)
if (!dir.exists(results_dir)) dir.create(results_dir, recursive = TRUE, showWarnings = FALSE)
if (!dir.exists(data_dir_up)) dir.create(data_dir_up, recursive = TRUE, showWarnings = FALSE)

counts_up   <- file.path(data_dir_up, "sim_counts.rds")
counts_here <- file.path(data_dir_here, "sim_counts.rds")

has_up <- file.exists(counts_up); has_here <- file.exists(counts_here)
if (!has_up && !has_here) {
  message("Synthetic counts not found; generating via R/01_generate_synthetic_data.R ...")
  old <- getwd(); on.exit(setwd(old), add=TRUE); setwd("..")
  source(file.path("R","01_generate_synthetic_data.R"), local=TRUE)
  setwd(old)
  has_up <- file.exists(counts_up); has_here <- file.exists(counts_here)
}
if (!has_up && has_here) {
  file.copy(counts_here, counts_up, overwrite = TRUE)
  has_up <- TRUE
}
stopifnot(has_up)
counts <- readRDS(counts_up)
stopifnot(inherits(counts, "dgCMatrix"))

seu <- CreateSeuratObject(counts = counts, project = "synthetic", min.cells = 3, min.features = 200)
seu[["percent.mt"]] <- PercentageFeatureSet(seu, pattern = "^MT-")
seu <- subset(seu, subset = nFeature_RNA > 200 & nFeature_RNA < 4000 & percent.mt < 20)

if (is.null(seu@reductions$umap)) {
  seu <- NormalizeData(seu)
  seu <- FindVariableFeatures(seu, selection.method = "vst", nfeatures = 2000)
  seu <- ScaleData(seu, features = VariableFeatures(seu))
  seu <- RunPCA(seu, features = VariableFeatures(seu), npcs = 30)
  seu <- RunUMAP(seu, dims = 1:20)
  seu <- FindNeighbors(seu, dims = 1:20)
  seu <- FindClusters(seu, resolution = 0.5)
}

# Compatibility aliases
if (!exists("seurat.integrated")) seurat.integrated <- seu
if (!exists("obj")) obj <- seu

save_fig <- function(p, name, width=7, height=5, dpi=150) {
  ggsave(filename = file.path(results_dir, name), plot = p, width = width, height = height, dpi = dpi)
}
```

## Differential Expression per cluster

```{r de-markers}
markers <- FindAllMarkers(seu, only.pos = TRUE, min.pct = 0.2, logfc.threshold = 0.25)
markers_top <- markers %>% group_by(cluster) %>% slice_max(order_by = avg_log2FC, n = 100) %>% ungroup()
write.csv(markers_top, file.path(results_dir, "go_markers_top100_per_cluster.csv"), row.names = FALSE)
head(markers_top)
```

## GO Enrichment (preferred: clusterProfiler + org.Hs.eg.db)

```{r go-enrichment, message=TRUE, warning=TRUE}
# ==================== GO enrichment (always returns hits if FORCE_HIT=TRUE) ====================

# 0) 合成名→既知シンボルへ
make_human_symbols <- function(n) {
  syms <- character(0)
  if (requireNamespace("org.Hs.eg.db", quietly = TRUE)) {
    suppressPackageStartupMessages(library(org.Hs.eg.db))
    syms <- AnnotationDbi::keys(org.Hs.eg.db, keytype = "SYMBOL")
  } else if (requireNamespace("msigdbr", quietly = TRUE)) {
    syms <- unique(msigdbr::msigdbr(species = "Homo sapiens")$gene_symbol)
  }
  if (length(syms) == 0) {
    syms <- c(
      "GAPDH","ACTB","ACTG1","RPLP0","RPL13A","RPS18","B2M","TUBB","HPRT1","EEF1A1",
      "RPL3","RPS3","RPS6","RPS19","RPLP1","RPL7","RPL10","RPS9","RPS27A","PGK1",
      "MT-CO1","MT-CO2","MT-CO3","MT-ND1","MT-ND2","MT-ND4","MT-CYB",
      "CD3D","CD3E","CD2","CD4","CD8A","CD8B","CCR7","IL7R","MS4A1","LYZ","GNLY","NKG7",
      "PPBP","SDC1","KLRD1","FOXP3","MS4A7","FCGR3A","FCER1A","CST3","COL1A1","COL1A2"
    )
  }
  if (length(syms) >= n) sample(syms, n, replace = FALSE) else sample(syms, n, replace = TRUE)
}
u <- sort(unique(markers_top$gene))
sym_map <- setNames(make_human_symbols(length(u)), u)
markers_top$gene <- unname(sym_map[markers_top$gene])
if (!exists("markers")) {
  markers <- markers_top %>% dplyr::select(gene, avg_log2FC, cluster) %>% dplyr::rename(rank = avg_log2FC)
} else {
  markers$gene <- unname(sym_map[markers$gene])
}

# 1) 使うセットの用意（msigdbrの新APIに対応）＋ 内蔵の小型セット
has_msigdbr <- requireNamespace("msigdbr", quietly = TRUE)
if (has_msigdbr) {
  msig <- msigdbr::msigdbr(species = "Homo sapiens", collection = "C5", subcollection = "GO:BP")
  gsets <- split(msig$gene_symbol, msig$gs_name)
} else {
  gsets <- list(
    `GO_T_CELL_ACTIVATION`          = c("CD3D","CD3E","CD2","CD4","CD8A","CD8B","IL7R","CCR7"),
    `GO_NK_CELL_MEDIATED_IMMUNITY`  = c("NKG7","GNLY","KLRD1","FCGR3A"),
    `GO_MONOCYTE_ACTIVATION`        = c("LYZ","MS4A7","FCGR3A"),
    `GO_B_CELL_RECEPTOR_SIGNALING`  = c("MS4A1"),
    `GO_TRANSLATION`                = c("RPS3","RPS6","RPS19","RPL3","RPL7","RPL10","RPLP0","RPL13A","RPS18"),
    `GO_MITOCHONDRIAL_RESPIRATION`  = c("MT-CO1","MT-CO2","MT-CO3","MT-ND1","MT-ND2","MT-ND4","MT-CYB")
  )
}

# 2) 追加パッケージ無しで動く ORA（Fisher）
safe_simple_ora <- function(sig_genes, bg_genes, gsets, min_size = 3, max_size = 5000) {
  sig_genes <- unique(intersect(sig_genes, bg_genes))
  if (length(sig_genes) == 0) return(NULL)
  res <- lapply(names(gsets), function(gs) {
    S <- unique(intersect(gsets[[gs]], bg_genes))
    if (length(S) < min_size || length(S) > max_size) return(NULL)
    k <- length(intersect(sig_genes, S))
    m <- length(S); K <- length(sig_genes); N <- length(bg_genes)
    mat <- matrix(c(k, K-k, m-k, N-m-(K-k)), nrow = 2)
    p  <- tryCatch(fisher.test(mat, alternative = "greater")$p.value, error=function(e) NA_real_)
    data.frame(pathway = gs, overlap = k, size = m, K = K, N = N, pval = p, stringsAsFactors = FALSE)
  })
  res <- dplyr::bind_rows(res)
  if (!is.null(res) && nrow(res) > 0) {
    res$padj <- p.adjust(res$pval, method = "BH")
    res <- res[order(res$padj, res$pval), ]
  }
  res
}

# 3) 可視化を確実にするためのスパイク（より強め）
FORCE_HIT <- TRUE  # ← ヒット演出をしたくない時は FALSE に

# “強制ヒット用”の小さいセットを 1 本追加（名前に GOBP_ を付けてGO風に）
FORCE_HIT_GENES <- c("CD3D","CD3E","CD2","CD4","CD8A","CCR7","IL7R","MS4A1")
gsets[["GOBP_DEMO_FORCED_HIT"]] <- FORCE_HIT_GENES

# 4) 実行（背景は十分大きく、セット全体は背景に必ず含める）
bg_all <- unique(c(markers_top$gene, unlist(gsets, use.names = FALSE)))
go_results <- list()

for (cl in sort(unique(markers$cluster))) {
  sig <- markers %>% dplyr::filter(cluster == cl) %>% dplyr::pull(gene) %>% unique()

  if (FORCE_HIT) {
    sel <- "GOBP_DEMO_FORCED_HIT"
    # セットの 75% 程度をシグに注入して、ORAで強めに効かせる
    add_n <- ceiling(0.75 * length(gsets[[sel]]))
    sig <- unique(c(sig, sample(gsets[[sel]], add_n)))
    # 背景には全セットを入れておく
    bg_all <- unique(c(bg_all, unlist(gsets, use.names = FALSE)))
  }

  ora <- safe_simple_ora(
    sig_genes = sig, bg_genes = bg_all, gsets = gsets,
    min_size = 3, max_size = 5000
  )
  if (!is.null(ora) && nrow(ora) > 0) {
    ora$cluster <- cl
    # 可視化は padj だと 1.0 に張り付きやすいので “p値” で順位付け＆表示
    ora <- ora[order(ora$pval, ora$padj), ]
    go_results[[as.character(cl)]] <- head(ora, 10)

    # ---- 可視化（p値で描画、白背景を明示、棒色も指定）
    pdat <- head(ora, 10)
    p <- ggplot(pdat, aes(reorder(pathway, -log10(pval + 1e-12)), -log10(pval + 1e-12))) +
      geom_col(fill = "steelblue") +
      coord_flip() +
      labs(x = "GO pathway", y = "-log10(p)", title = paste("ORA (cluster", cl, ")")) +
      theme_minimal(base_size = 12) +
      theme(
        panel.grid.major.y = element_blank(),
        panel.grid.minor   = element_blank(),
        plot.title         = element_text(hjust = 0.5),
        plot.background    = element_rect(fill = "white", colour = NA),
        panel.background   = element_rect(fill = "white", colour = NA),
        legend.background  = element_rect(fill = "white", colour = NA)
      )
    ggsave(
      filename = file.path(results_dir, sprintf("go_ora_bar_cluster_%s.png", cl)),
      plot = p, width = 10, height = 6, dpi = 150, bg = "white"
    )
  }
}

# 5) 保存
if (length(go_results) > 0) {
  combined <- dplyr::bind_rows(go_results, .id = "cluster_id")
  out_csv <- file.path(results_dir, "go_enrichment_results.csv")
  write.csv(combined, out_csv, row.names = FALSE)
  cat("Saved GO results to:", out_csv, "\n")
} else {
  cat("No GO results (insufficient markers or packages).\n")
}


```